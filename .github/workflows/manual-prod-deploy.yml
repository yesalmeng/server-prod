name: Manual Deployment to Production Supabase and Fly.io
on:
  workflow_dispatch:

jobs:
  deploy-supabase:
    name: Deploy to Supabase
    runs-on: ubuntu-latest
    environment: production
    concurrency: supabase-deploy-group
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Link to Supabase DB
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      - name: Push migrations to remote DB
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # deploy-fly:
  #   name: Deploy to Fly
  #   runs-on: ubuntu-latest
  #   needs: deploy-supabase # run AFTER supabase migration is done
  #   environment: production
  #   concurrency: fly-deploy-group
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: superfly/flyctl-actions/setup-flyctl@master
  #     - run: flyctl deploy --config fly.toml --remote-only
  #       env:
  #         FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  dump-to-staging:
    name: Dump Prod → Staging
    runs-on: ubuntu-latest
    needs: deploy-supabase
    environment: production
    concurrency:
      group: dump-obfuscate
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Install psql
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq postgresql-client
      - name: Dump prod data into staging
        run: ./scripts/dump-prod-to-stg.sh
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}

  obfuscate:
    name: Obfuscate Staging Data
    runs-on: ubuntu-latest
    needs: dump-to-staging
    environment: staging
    concurrency:
      group: dump-obfuscate
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install dependencies
        run: pnpm install
      - name: Generate Prisma client
        run: pnpm db:generate
      # intentional failure to test wipe-on-failure -- REMOVE AFTER confirming we truncate tables after failing obfuscation job
      # - name: Force failure (test)
      #   run: exit 1
      - name: Run obfuscation
        run: pnpm run obfuscate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
      - name: Wipe staging data on failure
        if: failure()
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq postgresql-client
          psql "$DIRECT_URL" <<'SQL'
          DO $$
          DECLARE
              tbl text;
          BEGIN
              FOR tbl IN
                  SELECT tablename
                  FROM   pg_tables
                  WHERE  schemaname = 'public'
              LOOP
                  EXECUTE format('TRUNCATE TABLE public.%I CASCADE', tbl);
                  RAISE NOTICE 'truncated public.%', tbl;
              END LOOP;
          END;
          $$;
          SQL
          echo "⚠️  Staging wiped — obfuscation failed, no unmasked data left."
        env:
          DIRECT_URL: ${{ secrets.DIRECT_URL }}